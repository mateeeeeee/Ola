Module ID : test.ola

declare @Assert void(i8)


declare @AssertMsg void(i8,ptr)


define external @Base$GetValue i64(ptr %this) {
entry:
%0 = alloca i64
store 1, ptr %0
br label exit
return:
br label exit
exit:
%1 = load i64, ptr %0
ret i64 %1
}


define external @Base$GetDoubleValue i64(ptr %this) {
entry:
%0 = alloca i64
%1 = ptr add ptr %this, 0
%2 = load ptr, ptr %1
%3 = ptr add ptr %2, 0
%4 = load ptr, ptr %3
%5 = call ptr %this, %4
%6 = smul i64 %5, 2
store i64 %6, ptr %0
br label exit
return:
br label exit
exit:
%7 = load i64, ptr %0
ret i64 %7
}


define internal @VTable_Base ptr [@Base$GetValue,@Base$GetDoubleValue,]


define external @Derived$GetValue i64(ptr %this) {
entry:
%0 = alloca i64
store 10, ptr %0
br label exit
return:
br label exit
exit:
%1 = load i64, ptr %0
ret i64 %1
}


define external @Derived$GetDoubleValue i64(ptr %this) {
entry:
%0 = alloca i64
%1 = ptr add ptr %this, 0
%2 = load ptr, ptr %1
%3 = ptr add ptr %2, 0
%4 = load ptr, ptr %3
%5 = call ptr %this, %4
%6 = smul i64 %5, 2
store i64 %6, ptr %0
br label exit
return:
br label exit
exit:
%7 = load i64, ptr %0
ret i64 %7
}


define internal @VTable_Derived ptr [@Derived$GetValue,@Derived$GetDoubleValue,]


define internal @TestVirtualDispatch__Baseref__I void(ptr %b,i64 %expected) {
entry:
%0 = alloca ptr
store ptr %b, ptr %0
%1 = load ptr, ptr %0
%2 = alloca i64
store i64 %expected, ptr %2
%3 = ptr add ptr %1, 0
%4 = load ptr, ptr %3
%5 = ptr add ptr %4, 0
%6 = load ptr, ptr %5
%7 = call ptr %1, %6
%8 = load i64, ptr %2
%9 = icmp eq i64 %7, %8
call i8 %9, @Assert
br label exit
exit:
ret 
}


define internal @TestVirtualDispatchDouble__Baseref__I void(ptr %b,i64 %expected) {
entry:
%0 = alloca ptr
store ptr %b, ptr %0
%1 = load ptr, ptr %0
%2 = alloca i64
store i64 %expected, ptr %2
%3 = ptr add ptr %1, 0
%4 = load ptr, ptr %3
%5 = ptr add ptr %4, 8
%6 = load ptr, ptr %5
%7 = call ptr %1, %6
%8 = load i64, ptr %2
%9 = icmp eq i64 %7, %8
call i8 %9, @Assert
br label exit
exit:
ret 
}


define external @main i64() {
entry:
%0 = alloca i64
%1 = alloca %Base
%2 = ptr add ptr %1, 0
store ptr @VTable_Base, ptr %2
%3 = ptr add ptr %1, 0
%4 = load ptr, ptr %3
%5 = ptr add ptr %4, 0
%6 = load ptr, ptr %5
%7 = call ptr %1, %6
%8 = icmp eq i64 %7, 1
call i8 %8, @Assert
%9 = ptr add ptr %1, 0
%10 = load ptr, ptr %9
%11 = ptr add ptr %10, 8
%12 = load ptr, ptr %11
%13 = call ptr %1, %12
%14 = icmp eq i64 %13, 2
call i8 %14, @Assert
%15 = load %Base, ptr %1
call ptr %1, 1, @TestVirtualDispatch__Baseref__I
%16 = load %Base, ptr %1
call ptr %1, 2, @TestVirtualDispatchDouble__Baseref__I
%17 = alloca %Derived
%18 = ptr add ptr %17, 0
store ptr @VTable_Derived, ptr %18
%19 = ptr add ptr %17, 0
%20 = load ptr, ptr %19
%21 = ptr add ptr %20, 0
%22 = load ptr, ptr %21
%23 = call ptr %17, %22
%24 = icmp eq i64 %23, 10
call i8 %24, @Assert
%25 = ptr add ptr %17, 0
%26 = load ptr, ptr %25
%27 = ptr add ptr %26, 8
%28 = load ptr, ptr %27
%29 = call ptr %17, %28
%30 = icmp eq i64 %29, 20
call i8 %30, @Assert
%31 = load %Derived, ptr %17
call ptr %17, 10, @TestVirtualDispatch__Baseref__I
%32 = load %Derived, ptr %17
call ptr %17, 20, @TestVirtualDispatchDouble__Baseref__I
store 0, ptr %0
br label exit
return:
br label exit
exit:
%33 = load i64, ptr %0
ret i64 %33
}

